{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">{{ title if title else 'LTREMC Avamar Dashboard' }}</h1>

    {% if stats.is_override %}
    <div class="text-end lh-sm">
        <div class="text-muted small">Report Date: <strong>{{ stats.simulated_date }}</strong></div>
    </div>
    {% endif %}
</div>

{% if dropped_files %}
<div class="alert alert-warning" role="alert">
    <h5 class="alert-heading">Filtered Files</h5>
    <p>The following files were excluded being >12 hours older than the dataset max time:</p>
    <ul>
        {% for file in dropped_files %}
            <li>{{ file }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="row row-cols-1 row-cols-md-4 g-4 mb-4">
    <div class="col">
        <div class="card h-100 border-top-blue">
            <div class="card-body">
                <div class="card-label mb-2">Total Backups</div>
                <h2 class="card-title-lg text-primary mb-1">{{ "{:,}".format(stats.total_records) }}</h2>
                <small class="text-muted">Records Processed</small>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 border-top-green">
            <div class="card-body">
                <div class="card-label mb-2">Avamar Grids</div>
                <div>
                    <a href="#" class="text-decoration-none text-dark" data-bs-toggle="modal" data-bs-target="#modalTotalGrids">
                        <span class="h3 fw-normal">{{ "{:,}".format(stats.total_grids) }}</span>
                        <small class="text-muted ms-1">Total</small>
                    </a>
                </div>
                <div class="mt-2 pt-2 border-top">
                    <a href="#" class="text-decoration-none text-success" data-bs-toggle="modal" data-bs-target="#modalActiveGrids">
                        <span class="h4 fw-normal">{{ "{:,}".format(stats.recent_grids) }}</span>
                        <small class="text-muted ms-1">Active</small>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 border-top-orange">
            <div class="card-body">
                <div class="card-label mb-2">Customers</div>
                <div>
                     <a href="#" class="text-decoration-none text-dark" data-bs-toggle="modal" data-bs-target="#modalTotalCustomers">
                        <span class="h3 fw-normal">{{ "{:,}".format(stats.total_customers) }}</span>
                        <small class="text-muted ms-1">Total</small>
                     </a>
                </div>
                <div class="mt-2 pt-2 border-top">
                     <a href="#" class="text-decoration-none text-warning" data-bs-toggle="modal" data-bs-target="#modalActiveCustomers">
                        <span class="h4 fw-normal">{{ "{:,}".format(stats.recent_customers) }}</span>
                        <small class="text-muted ms-1">Active</small>
                     </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 border-top-gray">
            <div class="card-body">
                <div class="card-label mb-2">Clients</div>
                <div>
                    <a href="#" class="text-decoration-none text-dark" data-bs-toggle="modal" data-bs-target="#modalTotalClients">
                        <span class="h3 fw-normal">{{ "{:,}".format(stats.total_clients) }}</span>
                        <small class="text-muted ms-1">Total</small>
                    </a>
                </div>
                <div class="mt-2 pt-2 border-top">
                     <a href="#" class="text-decoration-none text-secondary" data-bs-toggle="modal" data-bs-target="#modalActiveClients">
                        <span class="h4 fw-normal">{{ "{:,}".format(stats.recent_clients) }}</span>
                        <small class="text-muted ms-1">Active</small>
                     </a>
                </div>
            </div>
        </div>
    </div>
</div>




<!-- Backup Activity Section -->
<h3 class="mt-4 mb-3 border-bottom pb-2">Backup Activity</h3>

<div class="card border-primary mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Recent Activity (Last 7 Days)</h5>
    </div>
    <div class="card-body">
        <!-- Summary Row -->
        <div class="row align-items-center mb-4">
            <div class="col-md-2 text-center border-end">
                <h2 class="display-6 fw-bold mb-0">
                    {{ stats.activity_breakdown.values() | sum }}
                </h2>
                <small class="text-muted">Total Jobs</small>
            </div>
            <div class="col-md-10">
                 {% if stats.activity_breakdown %}
                 <div class="table-responsive">
                    <table class="table table-bordered text-center mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="small text-start">Metric</th>
                                {% for key in stats.sorted_activity_keys %}
                                    <th class="small">{{ key }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Jobs Row -->
                            <tr>
                                <td class="text-start fw-bold text-secondary">Jobs</td>
                                {% for key in stats.sorted_activity_keys %}
                                    <td class="fw-bold">{{ "{:,}".format(stats.activity_breakdown.get(key, 0)) }}</td>
                                {% endfor %}
                            </tr>
                            <!-- Size Row -->
                            <tr>
                                <td class="text-start fw-bold text-secondary">Size (GB)</td>
                                {% for key in stats.sorted_activity_keys %}
                                    <td>{{ "{:,.2f}".format(stats.bytes_breakdown.get(key, 0)) }}</td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                 </div>
                 {% else %}
                 <p class="text-center text-muted my-3">No recent activity data available.</p>
                 {% endif %}
            </div>
        </div>

        <hr>

        <!-- Charts Row -->
         <div class="row">
            <div class="col-md-6 mb-3 mb-md-0">
                <h6 class="text-center text-secondary mb-3">Top 5 Clients (GB Written)</h6>
                <div style="height: 250px; position: relative; width: 100%; margin-bottom: 20px;">
                    <canvas id="topClientsChart"></canvas>
                </div>
                
                <table class="table table-sm table-striped small">
                    <thead class="table-light">
                        <tr>
                            <th>Client</th>
                            <th class="text-end">GB</th>
                            <th class="text-end">Oldest Expiry</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in stats.top_clients_breakdown %}
                        <tr>
                            <td>{{ item.client }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(item.gb) }}</td>
                            <td class="text-end">{{ item.oldest_expiry }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            </div>
            <div class="col-md-6">
                 <h6 class="text-center text-secondary mb-3">Top 5 Customers (GB Written)</h6>
                <div style="height: 250px; position: relative; width: 100%;">
                    <canvas id="topCustomersChart"></canvas>
                </div>
            </div>
        </div>
        
        {% if stats.top_inactive_clients_breakdown %}
        <hr>
        <!-- Inactive Clients Row -->
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h6 class="text-center text-secondary mb-3">Top 5 Inactive Clients (All Time GB)</h6>
                <p class="text-center small text-muted">Clients with no backups in the last 7 days.</p>
                <div style="height: 250px; position: relative; width: 100%; margin-bottom: 20px;">
                    <canvas id="topInactiveClientsChart"></canvas>
                </div>

                <div class="table-responsive" style="width: 80%; margin: 0 auto;">
                    <table class="table table-sm table-striped small">
                        <thead class="table-light">
                            <tr>
                                <th>Client</th>
                                <th class="text-end">GB</th>
                                <th class="text-end">Oldest Expiry</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stats.top_inactive_clients_breakdown %}
                            <tr>
                                <td>{{ item.client }}</td>
                                <td class="text-end">{{ "{:,.2f}".format(item.gb) }}</td>
                                <td class="text-end">{{ item.oldest_expiry }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>


<!-- Expiration Activity Section -->
<h3 class="mt-4 mb-3 border-bottom pb-2">Expiration Activity</h3>

<div class="card border-warning mb-4">
    <div class="card-header bg-warning text-white">
        <h5 class="mb-0">Expiring Soon (Next 30 Days)</h5>
    </div>
    <div class="card-body">
        <!-- Summary Row -->
        <div class="row align-items-center mb-4">
            <div class="col-md-2 text-center border-end">
                <h2 class="display-6 fw-bold mb-0">{{ "{:,}".format(stats.upcoming_expirations) }}</h2>
                <small class="text-muted">Total Expiring</small>
            </div>
            <div class="col-md-10">
                 {% if stats.expiration_breakdown %}
                 <div class="table-responsive">
                    <table class="table table-bordered text-center mb-0">
                        <thead class="table-light">
                            <tr>
                                {% for key in stats.sorted_expiration_keys %}
                                    <th class="small">{{ key }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                {% for key in stats.sorted_expiration_keys %}
                                    <td class="fw-bold">{{ "{:,}".format(stats.expiration_breakdown.get(key, 0)) }}</td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                 </div>
                 {% else %}
                 <p class="text-center text-muted my-3">No expiration breakdown data active.</p>
                 {% endif %}
            </div>
        </div>

        <hr>

        <!-- Charts Row -->
         <div class="row">
            <div class="col-md-6 mb-3 mb-md-0">
                <h6 class="text-center text-secondary mb-3">Top 5 Expiring Clients (GB Releasable)</h6>
                <div style="height: 250px; position: relative; width: 100%;">
                    <canvas id="topExpiringClientsChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-center text-secondary mb-3">Top 5 Expiring Customers (GB Releasable)</h6>
                <div style="height: 250px; position: relative; width: 100%;">
                    <canvas id="topExpiringCustomersChart"></canvas>
                </div>
            </div>
         </div>
    </div>
</div>

<!-- Inventory Summary Section -->
{% if stats.inventory_summary %}
<h3 class="mt-4 mb-3 border-bottom pb-2">Inventory Summary</h3>
<div class="card border-info mb-4">
    <div class="card-header bg-info text-dark bg-opacity-10 border-info">
        <h5 class="mb-0">Customer Breakdown</h5>
    </div>
    <div class="card-body p-0">
         <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light text-secondary sticky-top" style="position: sticky; top: 0; z-index: 1;">
                    <tr>
                        <th class="border-bottom-0">Customer</th>
                        <th class="text-end border-bottom-0">Client Count</th>
                        <th class="text-end border-bottom-0">Backups Count</th>
                        <th class="text-end border-bottom-0">Total Size (GB)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in stats.inventory_summary %}
                    <tr>
                        <td>{{ row.extracted_customer }}</td>
                        <td class="text-end">{{ "{:,}".format(row.client_count) }}</td>
                        <td class="text-end">{{ "{:,}".format(row.backup_count) }}</td>
                        <td class="text-end">{{ "{:,.2f}".format(row.total_gb) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
         </div>
    </div>
</div>
{% endif %}

<div class="alert alert-light border">
    <small class="text-muted">Statistics based on simulated report date: <strong>{{ stats.simulated_date }}</strong></small>
</div>

<div class="alert alert-info">
    Use the navigation menu above to drill down into <strong>Customer</strong> specific reports or view raw data per <strong>Avamar Grid</strong>.
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Top Clients Chart ---
        const clientsData = {{ stats.top_clients_breakdown | tojson }};
        const clientsCtx = document.getElementById('topClientsChart').getContext('2d');
        
        // Extract array of objects back to labels/data
        const clientLabels = clientsData.map(item => item.client);
        const clientValues = clientsData.map(item => item.gb);

        new Chart(clientsCtx, {
            type: 'bar',
            data: {
                labels: clientLabels,
                datasets: [{
                    label: 'GB Written',
                    data: clientValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // --- Top Customers Chart ---
        const customersData = {{ stats.top_customers_breakdown | tojson }};
        const customersCtx = document.getElementById('topCustomersChart').getContext('2d');
        
        let custLabels = [];
        let custValues = [];

        if (Array.isArray(customersData)) {
            custLabels = customersData.map(d => d.customer);
            custValues = customersData.map(d => d.gb);
        } else {
            custLabels = Object.keys(customersData);
            custValues = Object.values(customersData);
        }

        new Chart(customersCtx, {
            type: 'bar', 
            data: {
                labels: custLabels,
                datasets: [{
                    label: 'GB Written',
                    data: custValues,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', 
                scales: {
                    x: { beginAtZero: true }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // --- Top Inactive Clients Chart ---
        const inactiveData = {{ stats.top_inactive_clients_breakdown | tojson }};
        // Check if element exists before creating chart (it's conditional in HTML)
        const inactiveCanvas = document.getElementById('topInactiveClientsChart');
        if (inactiveCanvas && inactiveData.length > 0) {
            
            const inactiveLabels = inactiveData.map(item => item.client);
            const inactiveValues = inactiveData.map(item => item.gb);

            const inactiveCtx = inactiveCanvas.getContext('2d');
            new Chart(inactiveCtx, {
                type: 'bar',
                data: {
                    labels: inactiveLabels,
                    datasets: [{
                        label: 'Total Inactive GB',
                        data: inactiveValues,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    scales: {
                        x: { beginAtZero: true }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // --- Top Expiring Clients Chart ---
        const exClientsData = {{ stats.top_expiring_clients_breakdown | tojson }};
        
        // Handle Map (List of Dicts) or Object
        let exClientsLabels = [];
        let exClientsValues = [];

        if (Array.isArray(exClientsData)) {
             exClientsLabels = exClientsData.map(d => d.client);
             exClientsValues = exClientsData.map(d => d.gb);
        } else {
             // Fallback for object format
             exClientsLabels = Object.keys(exClientsData);
             exClientsValues = Object.values(exClientsData);
        }

        const exClientsCtx = document.getElementById('topExpiringClientsChart').getContext('2d');
        
        new Chart(exClientsCtx, {
            type: 'bar',
            data: {
                labels: exClientsLabels,
                datasets: [{
                    label: 'GB Releasable',
                    data: exClientsValues,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // --- Top Expiring Customers Chart ---
        const exCustomersData = {{ stats.top_expiring_customers_breakdown | tojson }};
        
        let exCustLabels = [];
        let exCustValues = [];

        if (Array.isArray(exCustomersData)) {
             exCustLabels = exCustomersData.map(d => d.customer);
             exCustValues = exCustomersData.map(d => d.gb);
        } else {
             exCustLabels = Object.keys(exCustomersData);
             exCustValues = Object.values(exCustomersData);
        }

        const exCustomersCtx = document.getElementById('topExpiringCustomersChart').getContext('2d');
        
        new Chart(exCustomersCtx, {
            type: 'bar',
            data: {
                labels: exCustLabels,
                datasets: [{
                    label: 'GB Releasable',
                    data: exCustValues,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    });
</script>

<!-- List Modals -->
{% macro list_modal(id, title, items) %}
<div class="modal fade" id="{{ id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {% if items %}
                <ul class="list-group list-group-flush">
                    {% for item in items %}
                    <li class="list-group-item py-2 small">{{ item }}</li>
                    {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted text-center my-3">No items found.</p>
                {% endif %}
            </div>
             <div class="modal-footer">
                <div class="small text-muted me-auto">{{ items|length }} items</div>
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{{ list_modal('modalTotalGrids', 'All Avamar Grids', stats.all_grids_list) }}
{{ list_modal('modalActiveGrids', 'Active Avamar Grids (Last 7 Days)', stats.active_grids_list) }}
{{ list_modal('modalTotalCustomers', 'All Customers', stats.all_customers_list) }}
{{ list_modal('modalActiveCustomers', 'Active Customers (Last 7 Days)', stats.active_customers_list) }}
{{ list_modal('modalTotalClients', 'All Clients', stats.all_clients_list) }}
{{ list_modal('modalActiveClients', 'Active Clients (Last 7 Days)', stats.active_clients_list) }}

{% endblock %}
