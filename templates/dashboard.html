{% extends 'base.html' %}

{% block content %}
{% set filename_suffix = 'Global' %}
{% if title %}
    {% if 'Avamar Grid: ' in title %}
        {% set filename_suffix = title.replace('Avamar Grid: ', '') %}
    {% elif 'Customer Report: ' in title %}
        {% set filename_suffix = title.replace('Customer Report: ', '') %}
    {% endif %}
{% endif %}
{% set print_filename = 'LTREMC_' ~ stats.simulated_date ~ '_' ~ filename_suffix ~ '.pdf' %}

<div class="d-flex justify-content-end mb-2 d-print-none" data-html2canvas-ignore="true">
    <button onclick="printReport('{{ print_filename }}')" class="btn btn-outline-secondary btn-sm me-1" title="Print">
        <i class="bi bi-printer-fill"></i>
    </button>
    <button onclick="exportPDF('{{ print_filename }}')" class="btn btn-outline-danger btn-sm" title="Export to PDF">
        <i class="bi bi-file-earmark-pdf-fill"></i>
    </button>
</div>

<div class="d-flex justify-content-between align-items-end mb-4 print-hero-header">
    <div class="d-flex align-items-center">
        <img src="{{ url_for('static', filename='img/logo-no-background.png') }}" alt="Logo" style="height: 60px; width: auto;" class="me-3">
        <h1 class="mb-0 fs-3" style="line-height: 1.1;">{{ title if title else 'LTREMC Avamar Dashboard' }}</h1>
    </div>

    <div class="text-end d-flex flex-column align-items-end flex-shrink-0 text-nowrap ms-3">
        {% if stats.is_override %}
        <div class="text-muted small">Report Date: <strong>{{ stats.simulated_date }}</strong></div>
        {% else %}
        <div class="text-muted small">Report Date: <strong>{{ stats.simulated_date }}</strong></div>
        {% endif %}
    </div>
</div>

{% if dropped_files %}
<div class="alert alert-warning" role="alert">
    <h5 class="alert-heading">Filtered Files</h5>
    <p>The following files were excluded being >12 hours older than the dataset max time:</p>
    <ul>
        {% for file in dropped_files %}
            <li>{{ file }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<div class="row row-cols-1 row-cols-md-4 g-4 mb-4">
    <div class="col">
        <div class="card h-100 border-top-blue">
            <div class="card-body">
                <div class="card-label mb-2">Total Backups</div>
                <h2 class="card-title-lg text-primary mb-1">{{ "{:,}".format(stats.total_records) }}</h2>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 border-top-green">
            <div class="card-body">
                <div class="card-label mb-2">Avamar Grids</div>
                <div>
                    <a href="#" class="text-decoration-none text-dark" data-bs-toggle="modal" data-bs-target="#modalTotalGrids">
                        <span class="h3 fw-normal">{{ "{:,}".format(stats.total_grids) }}</span>
                        <small class="text-muted ms-1">Total</small>
                    </a>
                </div>
                <div class="mt-2 pt-2 border-top">
                    <a href="#" class="text-decoration-none text-success" data-bs-toggle="modal" data-bs-target="#modalActiveGrids">
                        <span class="h4 fw-normal">{{ "{:,}".format(stats.recent_grids) }}</span>
                        <small class="text-muted ms-1">Active</small>
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 border-top-orange">
            <div class="card-body">
                <div class="card-label mb-2">Customers</div>
                <div>
                     <a href="#" class="text-decoration-none text-dark" data-bs-toggle="modal" data-bs-target="#modalTotalCustomers">
                        <span class="h3 fw-normal">{{ "{:,}".format(stats.total_customers) }}</span>
                        <small class="text-muted ms-1">Total</small>
                     </a>
                </div>
                <div class="mt-2 pt-2 border-top">
                     <a href="#" class="text-decoration-none text-warning" data-bs-toggle="modal" data-bs-target="#modalActiveCustomers">
                        <span class="h4 fw-normal">{{ "{:,}".format(stats.recent_customers) }}</span>
                        <small class="text-muted ms-1">Active</small>
                     </a>
                </div>
            </div>
        </div>
    </div>
    <div class="col">
        <div class="card h-100 border-top-gray">
            <div class="card-body">
                <div class="card-label mb-2">Clients</div>
                <div>
                    <a href="#" class="text-decoration-none text-dark" data-bs-toggle="modal" data-bs-target="#modalTotalClients">
                        <span class="h3 fw-normal">{{ "{:,}".format(stats.total_clients) }}</span>
                        <small class="text-muted ms-1">Total</small>
                    </a>
                </div>
                <div class="mt-2 pt-2 border-top">
                     <a href="#" class="text-decoration-none text-secondary" data-bs-toggle="modal" data-bs-target="#modalActiveClients">
                        <span class="h4 fw-normal">{{ "{:,}".format(stats.recent_clients) }}</span>
                        <small class="text-muted ms-1">Active</small>
                     </a>
                </div>
            </div>
        </div>
    </div>
</div>





<!-- Backup Activity Section -->
<!-- Removed print-section wrapper to allow splitting -->
<h3 class="mt-4 mb-3 border-bottom pb-2">Backup Activity</h3>

<div class="card border-primary mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">Recent Activity (Last 7 Days)</h5>
    </div>
    <div class="card-body">
        <!-- Summary Row -->
        <div class="row align-items-center mb-4 print-avoid-break">
            <div class="col-md-2 text-center border-end">
                <h2 class="display-6 fw-bold mb-0">
                    {{ stats.activity_breakdown.values() | sum }}
                </h2>
                <small class="text-muted">Total Jobs</small>
            </div>
            <div class="col-md-10">
                 {% if stats.activity_breakdown %}
                 <div class="table-responsive">
                    <table class="table table-bordered text-center mb-0 small" style="font-size: 0.75rem;">
                        <thead class="table-light">
                            <tr>
                                <th class="small text-start">Metric</th>
                                {% for key in stats.sorted_activity_keys %}
                                    <th class="small">{{ key }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Jobs Row -->
                            <tr>
                                <td class="text-start fw-bold text-secondary">Jobs</td>
                                {% for key in stats.sorted_activity_keys %}
                                    <td class="fw-bold">{{ "{:,}".format(stats.activity_breakdown.get(key, 0)) }}</td>
                                {% endfor %}
                            </tr>
                            <!-- Size Row -->
                            <tr>
                                <td class="text-start fw-bold text-secondary">Size (GB)</td>
                                {% for key in stats.sorted_activity_keys %}
                                    <td>{{ "{:,.2f}".format(stats.bytes_breakdown.get(key, 0)) }}</td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                 </div>
                 {% else %}
                 <p class="text-center text-muted my-3">No recent activity data available.</p>
                 {% endif %}
            </div>
        </div>

        <hr>

        <!-- Charts Row -->
         <div class="row print-avoid-break">
            <div class="col-md-6 mb-3 mb-md-0">
                <h6 class="text-center text-secondary mb-3">Top 5 Clients (GB Written)</h6>
                <div style="height: 250px; position: relative; width: 100%; margin-bottom: 20px;">
                    <canvas id="topClientsChart"></canvas>
                </div>
                
                <table class="table table-sm table-striped small">
                    <thead class="table-light">
                        <tr>
                            <th>Client</th>
                            <th class="text-end">GB</th>
                            <th class="text-end">Oldest Expiry</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in stats.top_clients_breakdown %}
                        <tr>
                            <td>{{ item.client }}</td>
                            <td class="text-end">{{ "{:,.2f}".format(item.gb) }}</td>
                            <td class="text-end">{{ item.oldest_expiry }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

            </div>
            <div class="col-md-6">
                 <h6 class="text-center text-secondary mb-3">Top 5 Customers (GB Written)</h6>
                <div style="height: 250px; position: relative; width: 100%;">
                    <canvas id="topCustomersChart"></canvas>
                </div>
            </div>
        </div>
        
        {% if stats.top_inactive_clients_breakdown %}
        <hr>
        <!-- Inactive Clients Row -->
        <div class="row justify-content-center print-avoid-break">
            <div class="col-md-8">
                <h6 class="text-center text-secondary mb-3">Top 5 Inactive Clients (All Time GB)</h6>
                <p class="text-center small text-muted">Clients with no backups in the last 7 days.</p>
                <div style="height: 250px; position: relative; width: 100%; margin-bottom: 20px;">
                    <canvas id="topInactiveClientsChart"></canvas>
                </div>

                <div class="table-responsive" style="width: 100%;">
                    <table class="table table-sm table-striped small">
                        <thead class="table-light">
                            <tr>
                                <th>Client</th>
                                <th class="text-end">GB</th>
                                <th class="text-end">Oldest Expiry</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in stats.top_inactive_clients_breakdown %}
                            <tr>
                                <td>{{ item.client }}</td>
                                <td class="text-end">{{ "{:,.2f}".format(item.gb) }}</td>
                                <td class="text-end">{{ item.oldest_expiry }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

    </div>
</div>




<!-- Expiration Activity Section -->
<div class="print-section">
<h3 class="mt-4 mb-3 border-bottom pb-2">Expiration Activity</h3>

<div class="card border-warning mb-4">
    <div class="card-header bg-warning text-white">
        <h5 class="mb-0">Expiring Soon (Next 30 Days)</h5>
    </div>
    <div class="card-body">
        <!-- Summary Row -->
        <div class="row align-items-center mb-4">
            <div class="col-md-3 text-center border-end">
                <h3 class="fw-bold mb-0">{{ "{:,}".format(stats.upcoming_expirations) }}</h3>
                <small class="text-muted">Total Expiring</small>
            </div>
            <div class="col-md-9">
                 {% if stats.expiration_breakdown %}
                 <div class="table-responsive">
                    <table class="table table-bordered table-sm text-center mb-0 small">
                        <thead class="table-light">
                            <tr>
                                {% for key in stats.sorted_expiration_keys %}
                                    <th class="small">{{ key }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                {% for key in stats.sorted_expiration_keys %}
                                    <td class="fw-bold">{{ "{:,}".format(stats.expiration_breakdown.get(key, 0)) }}</td>
                                {% endfor %}
                            </tr>
                        </tbody>
                    </table>
                 </div>
                 {% else %}
                 <p class="text-center text-muted my-3">No expiration breakdown data active.</p>
                 {% endif %}
            </div>
        </div>

        <hr>

        <!-- Charts Row -->
         <div class="row">
            <div class="col-md-6 mb-3 mb-md-0">
                <h6 class="text-center text-secondary mb-3">Top 5 Expiring Clients (GB Releasable)</h6>
                <div style="height: 250px; position: relative; width: 100%;">
                    <canvas id="topExpiringClientsChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <h6 class="text-center text-secondary mb-3">Top 5 Expiring Customers (GB Releasable)</h6>
                <div style="height: 250px; position: relative; width: 100%;">
                    <canvas id="topExpiringCustomersChart"></canvas>
                </div>
            </div>
         </div>
    </div>
</div>
</div>

<!-- Inventory Summary Section -->
<div class="print-section">
{% if stats.inventory_summary %}
<h3 class="mt-4 mb-3 border-bottom pb-2">Inventory Summary</h3>
<div class="card border-info mb-4">
    <div class="card-header bg-info text-dark bg-opacity-10 border-info">
        <h5 class="mb-0">
            {% if 'Customer Report:' in title %}
                Clients Breakdown
            {% else %}
                Customer Breakdown
            {% endif %}
        </h5>
    </div>
    <div class="card-body p-0">
         <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-striped table-hover mb-0">
                <thead class="table-light text-secondary sticky-top" style="position: sticky; top: 0; z-index: 1;">
                    <tr>
                        <th class="border-bottom-0" style="min-width: 300px;">{{ 'Client' if 'Customer Report:' in title else 'Customer' }}</th>
                        {% if 'Customer Report:' not in title %}
                        <th class="text-end border-bottom-0">Client Count</th>
                        {% endif %}
                        <th class="text-end border-bottom-0">Backups Count</th>
                        <th class="text-end border-bottom-0">Total Size (GB)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in stats.inventory_summary %}
                    <tr>
                        <td class="text-truncate" style="max-width: 300px;" title="{{ row.extracted_customer }}">{{ row.extracted_customer }}</td>
                        {% if 'Customer Report:' not in title %}
                        <td class="text-end">{{ "{:,}".format(row.client_count) }}</td>
                        {% endif %}
                        <td class="text-end">{{ "{:,}".format(row.backup_count) }}</td>
                        <td class="text-end">{{ "{:,.2f}".format(row.total_gb) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
         </div>
    </div>
</div>
{% endif %}
</div>


<div class="alert alert-light border">
    <small class="text-muted">Statistics based on report date: <strong>{{ stats.simulated_date }}</strong></small>
</div>

<div class="alert alert-info">
    Use the navigation menu above to drill down into <strong>Customer</strong> specific reports or view raw data per <strong>Avamar Grid</strong>.
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Top Clients Chart ---
        const clientsData = {{ stats.top_clients_breakdown | tojson }};
        const clientsCtx = document.getElementById('topClientsChart').getContext('2d');
        
        // Extract array of objects back to labels/data
        const clientLabels = clientsData.map(item => item.client);
        const clientValues = clientsData.map(item => item.gb);

        new Chart(clientsCtx, {
            type: 'bar',
            data: {
                labels: clientLabels,
                datasets: [{
                    label: 'GB Written',
                    data: clientValues,
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // --- Top Customers Chart ---
        const customersData = {{ stats.top_customers_breakdown | tojson }};
        const customersCtx = document.getElementById('topCustomersChart').getContext('2d');
        
        let custLabels = [];
        let custValues = [];

        if (Array.isArray(customersData)) {
            custLabels = customersData.map(d => d.customer);
            custValues = customersData.map(d => d.gb);
        } else {
            custLabels = Object.keys(customersData);
            custValues = Object.values(customersData);
        }

        new Chart(customersCtx, {
            type: 'bar', 
            data: {
                labels: custLabels,
                datasets: [{
                    label: 'GB Written',
                    data: custValues,
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y', 
                scales: {
                    x: { beginAtZero: true }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // --- Top Inactive Clients Chart ---
        const inactiveData = {{ stats.top_inactive_clients_breakdown | tojson }};
        // Check if element exists before creating chart (it's conditional in HTML)
        const inactiveCanvas = document.getElementById('topInactiveClientsChart');
        if (inactiveCanvas && inactiveData.length > 0) {
            
            const inactiveLabels = inactiveData.map(item => item.client);
            const inactiveValues = inactiveData.map(item => item.gb);

            const inactiveCtx = inactiveCanvas.getContext('2d');
            new Chart(inactiveCtx, {
                type: 'bar',
                data: {
                    labels: inactiveLabels,
                    datasets: [{
                        label: 'Total Inactive GB',
                        data: inactiveValues,
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', 
                    scales: {
                        x: { beginAtZero: true }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // --- Top Expiring Clients Chart ---
        const exClientsData = {{ stats.top_expiring_clients_breakdown | tojson }};
        
        // Handle Map (List of Dicts) or Object
        let exClientsLabels = [];
        let exClientsValues = [];

        if (Array.isArray(exClientsData)) {
             exClientsLabels = exClientsData.map(d => d.client);
             exClientsValues = exClientsData.map(d => d.gb);
        } else {
             // Fallback for object format
             exClientsLabels = Object.keys(exClientsData);
             exClientsValues = Object.values(exClientsData);
        }

        const exClientsCtx = document.getElementById('topExpiringClientsChart').getContext('2d');
        
        new Chart(exClientsCtx, {
            type: 'bar',
            data: {
                labels: exClientsLabels,
                datasets: [{
                    label: 'GB Releasable',
                    data: exClientsValues,
                    backgroundColor: 'rgba(255, 159, 64, 0.6)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // --- Top Expiring Customers Chart ---
        const exCustomersData = {{ stats.top_expiring_customers_breakdown | tojson }};
        
        let exCustLabels = [];
        let exCustValues = [];

        if (Array.isArray(exCustomersData)) {
             exCustLabels = exCustomersData.map(d => d.customer);
             exCustValues = exCustomersData.map(d => d.gb);
        } else {
             exCustLabels = Object.keys(exCustomersData);
             exCustValues = Object.values(exCustomersData);
        }

        const exCustomersCtx = document.getElementById('topExpiringCustomersChart').getContext('2d');
        
        new Chart(exCustomersCtx, {
            type: 'bar',
            data: {
                labels: exCustLabels,
                datasets: [{
                    label: 'GB Releasable',
                    data: exCustValues,
                    backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                scales: {
                    x: { beginAtZero: true }
                },
                responsive: true,
                maintainAspectRatio: false
            }
        });
    });
</script>

<!-- List Modals -->
{% macro list_modal(id, title, items) %}
<div class="modal fade" id="{{ id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content border-0 shadow-lg" style="overflow: hidden;">
            <div class="modal-header text-white" style="background-color: var(--dell-blue, #0076CE);">
                <h5 class="modal-title fw-light">
                    <i class="bi bi-list-ul me-2"></i>{{ title }}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body bg-light p-0">
                {% if items %}
                <ul class="list-group list-group-flush">
                    {% for item in items %}
                    <li class="list-group-item list-group-item-action py-2 px-4 small border-bottom border-light text-secondary">
                        {{ item }}
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="text-center py-5">
                    <p class="text-muted mb-0">No items found.</p>
                </div>
                {% endif %}
            </div>
             <div class="modal-footer bg-light border-top">
                <div class="small text-muted me-auto badge bg-secondary bg-opacity-10 text-secondary border border-secondary border-opacity-25 shadow-sm px-3 py-2 rounded-pill">
                    {{ items|length }} Items
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm px-4" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endmacro %}

{{ list_modal('modalTotalGrids', 'All Avamar Grids', stats.all_grids_list) }}
{{ list_modal('modalActiveGrids', 'Active Avamar Grids (Last 7 Days)', stats.active_grids_list) }}
{{ list_modal('modalTotalCustomers', 'All Customers', stats.all_customers_list) }}
{{ list_modal('modalActiveCustomers', 'Active Customers (Last 7 Days)', stats.active_customers_list) }}
{{ list_modal('modalTotalClients', 'All Clients', stats.all_clients_list) }}
{{ list_modal('modalActiveClients', 'Active Clients (Last 7 Days)', stats.active_clients_list) }}

<!-- PDF Success Modal -->
<div class="modal fade" id="pdfSuccessModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title text-success">
                    Export Complete
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>The PDF report has been generated and saved.</p>
                <p class="text-muted small mb-0">Please check your browser's default download location (usually the Downloads folder).</p>
                <p class="text-muted small mt-2">Filename: <span id="pdfDownloadName" class="fw-bold"></span></p>
            </div>
            <div class="modal-footer border-top-0">
                <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
    function printReport(filename) {
        const originalTitle = document.title;
        document.title = filename;
        window.print();
        setTimeout(() => {
            document.title = originalTitle;
        }, 1000);
    }

    function exportPDF(filename) {
        // Create overlay
        const overlay = document.createElement('div');
        overlay.id = 'export-overlay';
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'white';
        overlay.style.zIndex = '9999';
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.flexDirection = 'column';
        overlay.innerHTML = '<div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;"></div><h5 class="text-muted">Generating PDF Report...</h5><p class="text-muted small">This may take a few seconds.</p>';
        document.body.appendChild(overlay);

        document.body.classList.add('pdf-export-mode');
        // Scroll to top to ensure capture starts from top
        window.scrollTo(0,0);
        
        // Target the report container specifically
        const element = document.querySelector('.report-container'); 
        
        const opt = {
            margin:       [2, 2, 2, 2], // Reduced to 2mm to prevent clipping
            filename:     filename,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  {  
                scale: 2, 
                useCORS: true, 
                logging: false,
                scrollY: 0
                // Removed windowWidth to let it detect natural size
            },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };

        // UI Feedback - Button (Keeping this but overlay covers it)
        const btn = event.currentTarget;
        const orgHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        document.body.style.cursor = 'wait';
        
        // Wait a tick for CSS reflow
        setTimeout(() => {
            html2pdf().set(opt).from(element).save().then(() => {
                document.body.classList.remove('pdf-export-mode');
                document.body.style.cursor = 'default';
                btn.innerHTML = orgHtml;
                
                // Remove overlay
                if (document.getElementById('export-overlay')) {
                    document.getElementById('export-overlay').remove();
                }

                // Show Success Modal
                document.getElementById('pdfDownloadName').innerText = filename;
                var pdfModal = new bootstrap.Modal(document.getElementById('pdfSuccessModal'));
                pdfModal.show();
            }).catch(err => {
                console.error('PDF Export Error:', err);
                alert('Error generating PDF.');
                document.body.classList.remove('pdf-export-mode');
                document.body.style.cursor = 'default';
                btn.innerHTML = orgHtml;
                // Remove overlay
                if (document.getElementById('export-overlay')) {
                    document.getElementById('export-overlay').remove();
                }
            });
        }, 500); // Increased timeout to ensure overlay renders effectively before heavy lifting
    }
</script>
{% endblock %}
