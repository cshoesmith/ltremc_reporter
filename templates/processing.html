
{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-8">
        <div class="card shadow-sm border-top-blue">
            <div class="card-header bg-white border-0 pt-3 pb-0">
                <h5 class="mb-0 text-primary fw-normal">Processing Report</h5>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <!-- Reserved space for 2 lines of text -->
                    <div class="d-flex align-items-center justify-content-center mb-2" style="height: 3.2rem; overflow: hidden;">
                        <h5 id="status-message" class="mb-0 text-secondary" style="font-size: 1.1rem; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">Initializing</h5>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const taskId = "{{ task_id }}";
    const statusUrl = "/status/" + taskId;
    const progressBar = document.getElementById('progress-bar');
    const statusMessage = document.getElementById('status-message');

    function checkStatus() {
        fetch(statusUrl)
            .then(response => response.json())
            .then(data => {
                // Update Progress
                progressBar.style.width = data.percent + "%";
                progressBar.textContent = data.percent + "%";
                progressBar.setAttribute('aria-valuenow', data.percent);
                statusMessage.textContent = data.message;

                if (data.state === 'completed') {
                    // Update recents cookie if filepath is provided
                    if (data.filepath) {
                        try {
                            let recents = [];
                            const match = document.cookie.match(new RegExp('(^| )recents=([^;]+)'));
                            if (match) {
                                try {
                                    recents = JSON.parse(decodeURIComponent(match[2]));
                                } catch(e) { console.error("Bad cookie json", e); }
                            }
                            
                            // Remove if exists (to move to top)
                            recents = recents.filter(p => p !== data.filepath);
                            // Add to top
                            recents.unshift(data.filepath);
                            // Keep max 5
                            recents = recents.slice(0, 5);
                            
                            // Set cookie (expire in 30 days)
                            const d = new Date();
                            d.setTime(d.getTime() + (30*24*60*60*1000));
                            document.cookie = "recents=" + encodeURIComponent(JSON.stringify(recents)) + ";expires=" + d.toUTCString() + ";path=/;SameSite=Lax";
                        } catch(e) {
                            console.error("Error setting cookie", e);
                        }
                    }

                    setTimeout(() => {
                        window.location.href = "/dashboard";
                    }, 1000);
                } else if (data.state === 'failed') {
                    alert("Processing Failed: " + data.error);
                    window.location.href = "/";
                } else {
                    setTimeout(checkStatus, 500);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                setTimeout(checkStatus, 2000); // Retry slower on error
            });
    }

    // Start polling
    document.addEventListener('DOMContentLoaded', checkStatus);
</script>
{% endblock %}
